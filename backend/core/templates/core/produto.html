{% extends "core/base.html" %}
{% load static %}

{% block title %}Detalhes do Produto{% endblock %}

{% block main_content %}
<div class="container mt-5" id="product-detail">

    {{ product_id|json_script:"product-id-data" }}
    {{ endpoint_url|json_script:"product-endpoint-data" }}

    <div class="row">
        <div class="col-md-6">
            <img id="product-image" src="" alt="Imagem do produto" class="img-fluid rounded shadow">
        </div>
        <div class="col-md-6">
            <h2 id="product-name" class="mb-3"></h2>
            <p id="product-description" class="text-muted"></p>

            <ul class="list-group mb-3">
                <li class="list-group-item"><strong>Categoria:</strong> <span id="product-category"></span></li>
                <li class="list-group-item"><strong>Marca:</strong> <span id="product-brand"></span></li>
                <li class="list-group-item"><strong>Menor Preço:</strong> R$ <span id="product-price"></span></li>
            </ul>

            <h5 class="mt-4">Ofertas Disponíveis</h5>
            <ul id="offers-list" class="list-group"></ul>
        </div>
    </div>

    <hr class="my-5">

    <h4>Comentários</h4>

    {% for comentario in comentarios %}
      <div class="border p-3 mb-3 rounded">
        <p class="mb-1">
          <strong>{{ comentario.usuario.username }}</strong> — {{ comentario.data|date:"d/m/Y H:i" }}
        </p>
        {% if comentario.nota %}
          <p class="mb-1">Nota: ⭐ {{ comentario.nota }}/5</p>
        {% endif %}
        <p class="mb-0">{{ comentario.texto }}</p>
      </div>
    {% empty %}
      <p class="text-muted">Nenhum comentário ainda.</p>
    {% endfor %}

    {% if request.user.is_authenticated %}
      <hr>
      <h5>Deixe seu comentário</h5>
      <form method="post" action="{% url 'core:comentar_produto' product_id %}" class="mt-3">
        {% csrf_token %}
        <div class="mb-3">
          <label for="id_texto" class="form-label">Comentário:</label>
          {{ form_comentario.texto }}
        </div>
        <div class="mb-3">
          <label for="id_nota" class="form-label">Nota (1 a 5):</label>
          {{ form_comentario.nota }}
        </div>
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    {% else %}
      <p class="text-muted mt-4">Faça <a href="{% url 'core:login' %}?next={{ request.path }}">login</a> para comentar.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const productIdElement = document.getElementById("product-id-data");
        const endpointElement = document.getElementById("product-endpoint-data");

        if (!productIdElement || !endpointElement) {
            console.error("❌ Elementos de dados não encontrados.");
            return;
        }

        const productId = JSON.parse(productIdElement.textContent);
        const endpoint = JSON.parse(endpointElement.textContent);

        fetch(endpoint)
            .then(response => {
                if (!response.ok) throw new Error("Produto não encontrado");
                return response.json();
            })
            .then(data => {
                const product = data.product;

                document.getElementById("product-image").src = product.imagem_url;
                document.getElementById("product-name").textContent = product.nome;
                document.getElementById("product-description").textContent = product.descricao;
                document.getElementById("product-category").textContent = product.categoria || "-";
                document.getElementById("product-brand").textContent = product.marca || "-";
                document.getElementById("product-price").textContent =
                    (product.menor_preco !== null && product.menor_preco !== undefined)
                        ? parseFloat(product.menor_preco).toFixed(2).replace('.', ',')
                        : "Indisponível";

                const offersList = document.getElementById("offers-list");
                offersList.innerHTML = "";

                if (product.ofertas && product.ofertas.length > 0) {
                    product.ofertas.forEach(oferta => {
                        const li = document.createElement("li");
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.innerHTML = `<strong>${oferta.loja}</strong> <span>R$ ${parseFloat(oferta.preco).toFixed(2).replace('.', ',')}</span>`;
                        offersList.appendChild(li);
                    });
                } else {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.textContent = "Nenhuma oferta disponível.";
                    offersList.appendChild(li);
                }
            })
            .catch(error => {
                console.error("❌ Erro ao carregar produto:", error);
                document.getElementById("product-detail").innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        ${error.message}<br>
                        Verifique se o produto existe ou se há problema com o backend.
                    </div>`;
            });
    });
</script>
{% endblock %}
